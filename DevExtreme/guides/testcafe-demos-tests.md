---
title: Testcafe demos tests
description: 
published: true
date: 2022-04-21T11:14:13.838Z
tags: 
editor: markdown
dateCreated: 2022-04-18T11:25:18.798Z
---

# Скриншотные TestCafe тесты для Widgets Gallery демок


## Для чего предназначены эти тесты

Начиная с 21_2 тесткафешные тесты на демки располагаются в репозитории **devextreme-demos**. Они гоняются в PR-ах **devextreme-demos** и **devextreme** репозиториев.

Эти тесты проверяют, что после изменений в коде не ломается функциональность демок и их внешний вид. В devextreme-demos репозитории также будет проверяться (но пока не реализовано) одинаковость внешнего вида демок в разных подходах: jquery, angularjs, angular, vue, react, mvc, mvc core и в разных темах.

Проверяются только демки. Поэтому новые тесты в **devextreme-demos** стоит писать только на сценарии, показанные в демках. Для сценариев, которых нет в демках, стоит использовать testcafe тесты в репозитории devextreme.

## Основные особенности

Тесты состоят из двух частей:

### 1. Автоматические тесты на внешний вид после загрузки
Эти тесты не нужно писать самостоятельно. Они автоматически генерируются на каждую имеющуюся демку. Код таких тестов располагается в файле `devextreme-demos/testing/common.test.js`.

Эти тесты открывают каждую демку и проверяют скриншот после загрузки. Эталоны скриншотов для этих тестов располагаются в папке `devextreme-demos/testing/etalons/`.

Для настройки этих тестов и для обеспечения стабильности этих тестов в папку с конкретной демок можно положить следующие файлы:
- client-script.js. Код, выполняющийся перед выполнением демки. В основном используется для мока new Date(), чтобы обеспечивать одинаковый внешний вид скриншотов.
- test-code.js. Код, выполняющийся после загрузки демки. Здесь выполняется кастомизация демки для обеспечения одинаково внешнего вида между запусками. Например, рандомные данные в виджете заменяются на фиксированные для обеспечения одинакового внешнего вида демки между прогонами (https://github.com/DevExpress/devextreme-demos/blob/21_2/JSDemos/Demos/Charts/Scatter/test-code.js).
- testcafe-test-code.js. Фрагмент testcafe кода, выполняющийся после загрузки демки перед взятием скриншота. Этот файл необходим в тех случаях, когда изначальный вид демки не отражает основную функциональность этой демки. Например, здесь может быть включен RTL режим или открыт попап (https://github.com/DevExpress/devextreme-demos/blob/21_2/JSDemos/Demos/DataGrid/RightToLeftSupport/testcafe-test-code.js).

### 2. Кастомные сценарные тесты на демки
Эти тесты пишутся вручную и кладутся в папку `devextreme-demos/testing/[widget-name]/`. Эталоны располагаются в папке `devextreme-demos/testing/[widget-name]/etalons/`.
В кастомных тестах следует выполнять типичные действия, под которые написана демка, а также снимать скриншоты между действиями.

Кастомные тесты нужны для проверки базовых сценариев в демках, чтобы не происходило отлома основной функциональности демок. Например, редактирование должно работать, данные должны сохраняться.

Если хотите написать скриншотные тесты на сложные и разные сценарии, которых нет в демках, то лучше использовать testcafe тесты в devextreme репе.

Пример сценарных тестов - https://github.com/DevExpress/devextreme-demos/blob/21_2/testing/widgets/datagrid/columns.test.js. 


## Как подложить эталоны

Сейчас нет способа прогнать тесты локально и подложить эталоны до создания PR-а. Эта возможность появится, но позже.
Поэтому нужно создавать PR без подложенных/подмененных эталонов и брать эталоны из артефактов.

После падения тестов в PR перейдите в детали упавших воркфлоу Visual Tests. В тулбаре сверху страницы есть кнопка Artifacts. Нажимаете и скачайте screenshots.zip. 
В этом архиве лежат эталоны, дифы, маски и новые скриншоты упавших скриншотных тестов:
- `WidgetName-DemoName.png`        - новый скриншот
- `WidgetName-DemoName_mask.png`   - маска
- `WidgetName-DemoName_etalon.png` - эталон
- `WidgetName-DemoName_diff.png`   - дифференс

Если вы создаете новую демку, то в архиве будут лежать только новые скриншоты.
Проверяйте, что скриншоты правильные для новой демки и копируйте их в папку `devextreme-demos/testing/etalons`.

Если у вас возникло падение при правке демки и это намеренные изменения, то из архива скопируйте только файлы вида `WidgetName-DemoName.png` в папку `devextreme-demos/testing/etalons`.

Если по умолчанию ваша демка показывает малополезные для скриншота данные и вы хотите сделать определенные действия перед скриншотом, то вы можете добавить файл `testcafe-test-code.js` в демку, где написать testcafe код, который выполняет клики или другие действия. Пример можно поглядеть в https://github.com/DevExpress/devextreme-demos/blob/21_2/JSDemos/Demos/DataGrid/RightToLeftSupport/testcafe-test-code.js

## Как обеспечить стабильность автоматических скриншотных тестов

### 1. Рандомные или периодические меняющиеся данные (test-code.js)

Если у вас в новой демке данные генерируются рандомным образом, то в папку демки нужно положить файл test-code.js, где следует написать код, заменяющий рандомные данные на фиксированные. Пример можно поглядеть в https://github.com/DevExpress/devextreme-demos/blob/21_2/JSDemos/Demos/Charts/AxisCustomPosition/test-code.js.

### 2. Отображение зависит от текущей даты (client-script.js)

Если внешний вид вашей демки зависит от текущей даны, то рекомендуется подкладывать файл client-script.js, где использую MockDate фиксировать текущую дату, использую MockDate. Пример можно поглядеть в https://github.com/DevExpress/devextreme-demos/blob/21_2/JSDemos/Demos/DateBox/Overview/pre-test-code.js

### 3. Другие случаи (маски)

Если первые два способа точно не помогают, следует подкладывать маски. 
Например, это могут быть следующие сценарии:
- рандомные guid-ы
- даты, которые возвращает сервер и они периодически меняются
- рендерится внешняя карта и ее внешний вид отличается между прогонами.

Для подкладывания маски скопируйте файл WidgetName-DemoName_mask.png из артефактов в `devextreme-demos/testing/etalons` для автоматических тестов и в `devextreme-demos/testing/[widget-name]/etalons/` для кастомных тестов.

Если автоматически сгенеарированная маска не подходит, то можно открыть файл WidgetName-DemoName_diff.png в GIMP и сделать из него маску.

## Поднятие скриншотных тестов на демки в devextreme репозиторим

Когда вы создаете в devextreme PR, который приводит к изменению внешнего вида виджетов, падает тесты в workflow Demos visual tests, которые проверяют, что изменения в devextreme не ломают демки.

Если вы хотите подменить скриншоты, в этом случае вы можете скачать артифакты в devextreme репе из Demos visual tests workflow и создать в devextreme-demos бранч с тем же именем, который был у исходного пр-а в devextreme. В этом бранче репы devextreme-demos вы заменяете эталоны и создаете отдельный пр уже в devextreme-demos репе. Поле этого вы можете перезапустить тесты в PR-е в devextreme репе. 

Скриншотные тесты устроены так, что при наличии 2-х пр-ов в devextreme и devextreme-demos репах от одного пользователя и с одинаковым именем бранча эти пр-ы считаются связанными и тесты гоняются по измененям из обоих веток.

## Как отлаживать скриншотные тесты

Полноценно прогнать тесты пока невозможно, так как эталоны корретны только для ubuntu.
Однако, можно запустить тест для отладки внешнего вида виджета перед взятием скриншота. Это может потребоваться при поломке функциональности видежта, а для отладки `client-script.js`, `test-code.js` и `testcafe-test-code.js` файлов, а также для отладки кастомных тестов.

Для отладки нужно:
1. Настройте .testcaferc.json

В нем поменяйте параметр "browsers" с "chrome:headless" на "chrome" и параметр "concurrency" с 4 на 1.

2. Настроить запуск только одного теста.

Для кастомного теста просто допишите ".only" после слова test. Например,
```javascript
test.only('ColumnCustomization', async (t) => {
```

Для автоматических тестов откройте файл `devextreme-demos/testing/common.test.js` и замените строчку
```javascript
test
```
на 
```javascript
(testName === 'DataGrid-Overview' ? test.only : test)
```
где DataGrid на свое имя виджета и Overview на свое имя демки.

3. Добавить остановку теста перед взятием скриншота.

Для этого добавьте перед командой 
```javascript
await t.expect(
```
следующий код:
```javascript
await t.debug()
```

4. Запустить веб сервер

В отдельном терминале откройте devextreme-demos и выполните команду:
```console
npm run webserver
```

5. Запустить тест

В терминале выполните команду:
```console
npm run test-testcafe
```

## Вопросы и ответы

### Можно ли прогнать эти тесты локально и получить скриншоты?

Запустить локально можно (npm run webserver в одном окне и npm run test-testcafe в другом), но они будут падать на скриншотах, так как в github actions используется ubuntu и там другой рендер шрифтов. Так что пока локально эти тесты будут падать. Но в скором будущем надеюсь создадим скрипт, который позволит гонять эти тесты локально в докере. Тогда можно будет получать корректные результаты и скриншоты локально.

### Что будет со старыми скриншотными тестами на ферме?

Пока что у нас для 21_2 тесты гоняются скриншотные тесты н демки и на ферме и на PR-ах. Поэтоиму временно придется подкладывать эталоны в двух местах. Однако, когда новые тесты покроют все сценарии старых, тесты с фермы будут либо удалены, либо будут гонять новые тесты из devextreme-demos.

### Будет ли работать скриншот репортер?

Пока нет, не будет. В будущем можно будет либо адаптировать текущую, либо написать новую, чтобы можно было также удобно как и раньше обновлять скриншоты, только уже в определенном пр-е.
